name: Omikuji Bot

on:
  repository_dispatch:
    types: [draw-omikuji]

ã€€jobs:
  draw_fortune:
        runs-on: ubuntu-latest
    steps:
      - name: Install bc and jq
        run: sudo apt-get update && sudo apt-get install bc jq -y

      - name: Draw a normal fortune
        id: normal_fortune
        run: |
          #!/bin/bash
          fortunes=("å¤§å‰" "ä¸­å‰" "å°å‰" "å‰" "æœ«å‰" "å‡¶" "å¤§å‡¶" "å¹³" "ğŸŒ±" "è¶…å¤§å‰")
          probabilities=(5 20 20 15 15 10 10 4 0.01 0.01)
          messages=("ã‚„ã£ãŸãƒ¼ï¼æœ€é«˜ã®é‹å‹¢ã§ã™ã€‚" "ä½•ã‹ã„ã„ã“ã¨ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚" "ã¾ã‚ã¾ã‚è‰¯ã„é‹å‹¢ã§ã™ã€‚" "æ™®é€šã®ä¸€æ—¥ã«ãªã‚Šãã†ã€‚" "ã¼ã¡ã¼ã¡ã§ã™ã€‚" "æ°—ã‚’ã¤ã‘ã¦éã”ã—ã¾ã—ã‚‡ã†ã€‚" "ä»Šæ—¥ã¯é™ã‹ã«éã”ã—ã¾ã—ã‚‡ã†ã€‚" "å¤‰åŒ–ã¯ãªã„ãŒã€ç©ã‚„ã‹ãªä¸€æ—¥ã€‚" "ã‚ãªãŸã®åŠªåŠ›ãŒèŠ½å¹ãæ—¥ã§ã™ã€‚" "å¥‡è·¡ãŒèµ·ã“ã‚‹ã‹ã‚‚ï¼Ÿï¼")
          
          RANDOM_NUMBER=$(echo "scale=2; 100 * $RANDOM / 32767" | bc)
          fortune_index=-1
          
          CUMULATIVE_PROB=0
          for i in "${!fortunes[@]}"; do
            CUMULATIVE_PROB=$(echo "$CUMULATIVE_PROB + ${probabilities[$i]}" | bc)
            if [ $(echo "$RANDOM_NUMBER <= $CUMULATIVE_PROB" | bc -l) -eq 1 ]; then
              fortune_index=$i
              break
            fi
          done

          echo "FORTUNE=${fortunes[$fortune_index]}" >> $GITHUB_ENV
          echo "MESSAGE=${messages[$fortune_index]}" >> $GITHUB_ENV

      - name: Send message to ChatWork
        run: |
          #!/bin/bash
          MESSAGE_TEXT="ã€ãŠã¿ãã˜ã®çµæœã€‘\nçµæœ: ${{ env.FORTUNE }}\nä¸€è¨€: ${{ env.MESSAGE }}"
          MESSAGE_ENCODED=$(echo -e "${MESSAGE_TEXT}" | jq -sRr @uri)
          
          curl -s -X POST \
            -H "X-ChatWorkToken: ${{ secrets.CHATWORK_TOKEN }}" \
            -d "body=${MESSAGE_ENCODED}" \
            "https://api.chatwork.com/v2/rooms/${{ secrets.CHATWORK_ROOM_ID }}/messages"
